<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ä¼šå‘è´¢é›†å›¢</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: #f0f2f5;
      padding: 30px;
    }
    h2, h3 { margin-top: 20px; color: #333; }
    .menu { margin-bottom: 20px; }
    .menu button {
      padding: 10px 20px; margin-right: 10px; font-size: 16px;
      background-color: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    .menu button:hover { background-color: #40a9ff; }
    .section {
      display: none; background: #fff; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .section.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    input, textarea {
      width: 100%; padding: 5px; margin-bottom: 10px; box-sizing: border-box;
    }
    pre {
      background: #f9f9f9; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h2>ğŸ›  ä¼šå‘è´¢é›†å›¢å¤šåŠŸèƒ½å·¥å…·</h2>

<div class="menu">
  <button onclick="showSection('txt')">ğŸ“‚ TXT æ–‡æœ¬æå–</button>
  <button onclick="showSection('report')">ğŸ“Š æŠ¥è¡¨å·¥å…·</button>
</div>

<!-- TXTæå– -->
<div id="section-txt" class="section">
  <h3>ğŸ“‚ æå– TXT æ–‡ä»¶çš„å‰ N è¡Œ</h3>
  <input type="file" id="fileInput" accept=".txt"><br>
  <label>è¾“å…¥è¦æå–çš„è¡Œæ•°ï¼š</label>
  <input type="number" id="lineCount" min="1" value="5"><br>
  <button onclick="processFile()">æå–å¹¶ç”Ÿæˆæ–‡ä»¶</button>
  <div id="result" style="margin-top:20px;"></div>
<hr style="margin:30px 0;">
<h3>ğŸ’° æ”¯å‡ºæ±‡æ€»å·¥å…·</h3>
<input type="file" id="salaryFiles" accept=".txt" multiple><br><br>
<button onclick="sumSalaryReports()">è®¡ç®—å·¥èµ„æ”¯å‡ºæ±‡æ€»</button>
<pre id="salarySummary" style="margin-top:20px;">ç­‰å¾…å¯¼å…¥æŠ¥è¡¨æ–‡ä»¶...</pre>

</div>

<!-- æŠ¥è¡¨å·¥å…· -->
<div id="section-report" class="section">
  <h3>ğŸ“Š ç¾¤å‡ºå·æŠ¥è¡¨å·¥å…·</h3>

  <table id="groupTable">
    <thead>
      <tr>
        <th>ç¾¤å</th><th>å‡ºå·æ•°</th><th>å•ä»·</th><th>æ”¶å…¥</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addRow()">â• æ·»åŠ ç¾¤</button>

  <h4>å‚æ•°è®¾ç½®</h4>
  <label>çœŸæœº/åè®®æˆæœ¬ï¼š</label>
  <input type="number" id="baseCost" value="2795">
  
  <!-- âœ… æ”¹ä¸º å·¥èµ„A+B -->
  <label>å·¥èµ„æ”¯å‡º <input type="text" id="salaryLabelA" value="F" style="width:40px;text-align:center;"> ï¼š</label>
<input type="number" id="salaryCostA" value="0">

<label>å·¥èµ„æ”¯å‡º <input type="text" id="salaryLabelB" value="Y" style="width:40px;text-align:center;"> ï¼š</label>
<input type="number" id="salaryCostB" value="57">


  <label>è¿”ç‚¹ç¾¤åï¼š</label>
  <input type="text" id="rebateGroup" value="é˜¿å›½ç¾¤">
  <label>è¿”ç‚¹æ¯”ä¾‹ï¼š</label>
  <input type="number" step="0.01" id="rebateRate" value="0.15">

  <button onclick="calculate()">ğŸ“Š è®¡ç®—æŠ¥è¡¨</button>
  <button onclick="exportTXT()">ğŸ“¥ å¯¼å‡ºæŠ¥è¡¨</button>
  <button onclick="exportHistory()">ğŸ“¤ å¯¼å‡ºå†å²</button>
  <button onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤å†å²</button>
  <button onclick="clearDraft()">ğŸ—‘ æ¸…é™¤æš‚å­˜</button>
  <button id="exportJsonBtn">ğŸ’¾ å¯¼å‡ºæŠ¥è¡¨ JSON</button>
  <button id="importJsonBtn">ğŸ“‚ å¯¼å…¥æŠ¥è¡¨ JSON</button>
  <input type="file" id="importJsonFile" accept=".json" style="display:none;">

  <h4>ğŸ“„ æŠ¥è¡¨é¢„è§ˆï¼š</h4>
  <pre id="output">ç‚¹å‡»â€œè®¡ç®—æŠ¥è¡¨â€åæ˜¾ç¤º</pre>

  <h4>ğŸ“ˆ å†å²åˆ©æ¶¦è®°å½•</h4>
  <ul id="historyList"></ul>
</div>

<script>
function showSection(id) {
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  document.getElementById('section-' + id).classList.add('active');
}
showSection('txt');

// ============ TXT åŠŸèƒ½ ============
function processFile() {
  const fileInput = document.getElementById('fileInput');
  const lineCount = parseInt(document.getElementById('lineCount').value);
  if (!fileInput.files[0]) return alert("è¯·å…ˆé€‰æ‹© TXT æ–‡ä»¶");
  const reader = new FileReader();
  reader.onload = function (e) {
    const lines = e.target.result.split(/\r?\n/);
    const extractPart = lines.slice(0, lineCount).join("\n");
    const remainingPart = lines.slice(lineCount).join("\n");
    createDownloadLink(extractPart, 'æå–éƒ¨åˆ†.txt');
    createDownloadLink(remainingPart, 'å‰©ä½™éƒ¨åˆ†.txt');
  };
  reader.readAsText(fileInput.files[0]);
}
function createDownloadLink(text, filename) {
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.textContent = `ğŸ“¥ ä¸‹è½½ï¼š${filename}`;
  link.style.display = 'block';
  document.getElementById('result').appendChild(link);
}

// ============ æŠ¥è¡¨åŠŸèƒ½ ============
let latestReport = '';
function addRow(group = '', count = '', price = '', remark = '') {
  const tbody = document.querySelector('#groupTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input value="${group}" class="groupName"></td>
    <td><input type="number" value="${count}" class="count" oninput="updateIncome(this)"></td>
    <td><input type="number" value="${price}" class="price" oninput="updateIncome(this)"></td>
    <td><input class="income" readonly></td>
    <td><input value="${remark}" class="remark"></td>
    <td><button onclick="this.closest('tr').remove(); saveDraft();">åˆ é™¤</button></td>
  `;
  tbody.appendChild(tr);
  updateIncome(tr.querySelector('.count'));
}

function updateIncome(elem) {
  const row = elem.closest('tr');
  const count = parseFloat(row.querySelector('.count').value) || 0;
  const price = parseFloat(row.querySelector('.price').value) || 0;
  row.querySelector('.income').value = (count * price).toFixed(2);
  saveDraft();
}

function calculate() {
  const rows = document.querySelectorAll('#groupTable tbody tr');
  const baseCost = parseFloat(document.getElementById('baseCost').value) || 0;

  // âœ… æ–°å¢å·¥èµ„A+Bè®¡ç®—
  const salaryA = parseFloat(document.getElementById('salaryCostA').value) || 0;
  const salaryB = parseFloat(document.getElementById('salaryCostB').value) || 0;
  const salaryCost = salaryA + salaryB;

  const rebateGroup = document.getElementById('rebateGroup').value.trim();
  const rebateRate = parseFloat(document.getElementById('rebateRate').value) || 0;

  let totalCount = 0, totalIncome = 0, rebateAmount = 0, lines = [];
  let errorMessages = [];

  rows.forEach(row => {
      const group = row.querySelector('.groupName').value.trim();
      const count = parseFloat(row.querySelector('.count').value) || 0;
      const price = parseFloat(row.querySelector('.price').value) || 0;
      const income = count * price;
      const remark = row.querySelector('.remark').value.trim();

      if (count > 0 && income < 0)
        errorMessages.push(`é—®é¢˜ï¼šç¾¤ã€${group}ã€‘çš„å‡ºå·æ•°ä¸º ${count}ï¼Œä½†æ”¶å…¥ä¸º è´Ÿï¼Œå–ä»€ä¹ˆå·ä¸è¦å–äº† è¿˜å€’è´´ï¼ï¼`);
      if (count > 0 && income === 0)
        errorMessages.push(`é—®é¢˜ï¼šç¾¤ã€${group}ã€‘çš„å‡ºå·æ•°ä¸º ${count}ï¼Œä½†æ”¶å…¥ä¸º 0ï¼Œä¸è¦è¿™æ ·å¸®è€æ¿çœé’±ï¼ï¼`);

      totalCount += count;
      totalIncome += income;
      let line = `${group.padEnd(8)} å‡ºå·æ•°: ${count}    å•ä»·: ${price}    æ”¶å…¥: ${income.toFixed(2)}`;
      if (remark) line += `    å¤‡æ³¨: ${remark}`;
      lines.push(line);
      if (group === rebateGroup) rebateAmount = count * rebateRate;
  });

  const totalCost = baseCost + salaryCost + rebateAmount;
  const profit = totalIncome - totalCost;
  const agentFee = profit * 0.15;
  const finalProfit = profit - agentFee;

  if (errorMessages.length > 0) {
      alert(`âš ï¸ å¯¼å‡ºæŠ¥è¡¨æ—¶å‡ºé”™ï¼š\n\n${errorMessages.join('\n')}`);
      return;
  }

  // âœ… æŠ¥è¡¨ä¸­å¢åŠ å·¥èµ„A/Bæ˜¾ç¤º
  let output = `ğŸ“… ç¾¤å‘å·æ˜ç»†\n\n`;
  output += lines.map(line => line + '\n').join('\n');
  output += `\nğŸ“Œ åˆè®¡å‡ºå·æ•°ï¼š${totalCount} ä¸ª\n\n`;
  output += `ğŸ“Œ åˆè®¡æ”¶å…¥ï¼š${totalIncome.toFixed(2)} U\n\n`;
  output += `ä¸€ã€çœŸæœºåè®®æˆæœ¬ï¼š${baseCost.toFixed(2)} U\n\n`;
const labelA = document.getElementById('salaryLabelA').value.trim() || 'A';
const labelB = document.getElementById('salaryLabelB').value.trim() || 'B';

output += `äºŒã€å·¥èµ„æ”¯å‡º${labelA}ï¼š${salaryA.toFixed(2)} U\n\n`;
output += `ä¸‰ã€å·¥èµ„æ”¯å‡º${labelB}ï¼š${salaryB.toFixed(2)} U\n\n`;

  output += `å››ã€è¿”ç‚¹ï¼ˆ${rebateGroup}ï¼‰ï¼š${rebateAmount.toFixed(2)} U\n\n`;
  output += `äº”ã€æ€»æ”¯å‡ºï¼š${totalCost.toFixed(2)} U\n\n`;
  output += `å…­ã€åˆ©æ¶¦ï¼š${totalIncome.toFixed(2)} - ${totalCost.toFixed(2)} = ${profit.toFixed(2)} U\n\n`;
  output += `ä¸ƒã€ä»£ç†ææˆï¼ˆ15%ï¼‰ï¼š${agentFee.toFixed(2)} U\n\n`;
  output += `âœ… æœ€ç»ˆåˆ©æ¶¦ï¼š${finalProfit.toFixed(2)} U\n`;

  latestReport = output;
  document.getElementById('output').textContent = output;

  const today = new Date().toISOString().slice(0, 10);
  let history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
  const currentProfit = parseFloat(finalProfit.toFixed(2));
  const index = history.findIndex(item => item.date === today);
  if (index >= 0) {
      if (currentProfit > parseFloat(history[index].profit)) {
          history[index].profit = currentProfit.toFixed(2);
      }
  } else {
      history.push({ date: today, profit: currentProfit.toFixed(2) });
  }
  localStorage.setItem('profitHistory', JSON.stringify(history));
  renderHistory();
}

function exportTXT() {
  if (!latestReport) return alert("è¯·å…ˆç‚¹å‡»â€œè®¡ç®—æŠ¥è¡¨â€");
  const today = new Date().toISOString().slice(0, 10);
  const blob = new Blob([latestReport], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `æŠ¥è¡¨-${today}.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function renderHistory() {
  const list = document.getElementById('historyList');
  const history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
  list.innerHTML = '';
  let total = 0;
  history.forEach(item => {
    total += parseFloat(item.profit);
    const li = document.createElement('li');
    li.textContent = `${item.date}ï¼š${item.profit} U`;
    list.appendChild(li);
  });
  if (history.length > 0) {
    const li = document.createElement('li');
    li.innerHTML = `<strong>ğŸ“Š æ€»åˆ©æ¶¦åˆè®¡ï¼š${total.toFixed(2)} U</strong>`;
    list.appendChild(li);
  }
}

function clearHistory() {
  if (confirm("ç¡®å®šæ¸…é™¤æ‰€æœ‰å†å²è®°å½•ï¼Ÿ")) {
    localStorage.removeItem('profitHistory');
    renderHistory();
  }
}

function exportHistory() {
  const history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
  if (!history.length) return alert("æš‚æ— å†å²è®°å½•");
  let total = 0;
  let text = `ğŸ“ˆ å†å²åˆ©æ¶¦è®°å½•\n\n`;
  history.forEach(item => {
    total += parseFloat(item.profit);
    text += `${item.date}ï¼š${item.profit} U\n\n`;
  });
  text += `ğŸ“Š æ€»åˆ©æ¶¦åˆè®¡ï¼š${total.toFixed(2)} U\n`;
  const today = new Date().toISOString().slice(0, 10);
  const blob = new Blob([text], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `å†å²åˆ©æ¶¦-${today}.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function saveDraft() {
  const rows = document.querySelectorAll('#groupTable tbody tr');
  const draftData = {
    groups: [],
    baseCost: document.getElementById('baseCost').value,
    salaryCostA: document.getElementById('salaryCostA').value,
    salaryCostB: document.getElementById('salaryCostB').value,
    rebateGroup: document.getElementById('rebateGroup').value,
    rebateRate: document.getElementById('rebateRate').value
  };
  rows.forEach(row => {
    draftData.groups.push({
      groupName: row.querySelector('.groupName').value,
      count: row.querySelector('.count').value,
      price: row.querySelector('.price').value,
      remark: row.querySelector('.remark').value
    });
  });
  localStorage.setItem('reportDraft', JSON.stringify(draftData));
}

function loadDraft() {
  const draft = localStorage.getItem('reportDraft');
  if (!draft) return false;
  const data = JSON.parse(draft);
  document.querySelector('#groupTable tbody').innerHTML = '';
  data.groups.forEach(g => addRow(g.groupName, g.count, g.price, g.remark));
  document.getElementById('baseCost').value = data.baseCost;
  document.getElementById('salaryCostA').value = data.salaryCostA || 0;
  document.getElementById('salaryCostB').value = data.salaryCostB || 0;
  document.getElementById('rebateGroup').value = data.rebateGroup;
  document.getElementById('rebateRate').value = data.rebateRate;
  return true;
}

function clearDraft() {
  if (confirm("ç¡®å®šæ¸…é™¤æš‚å­˜æ•°æ®ï¼Ÿ")) {
    localStorage.removeItem('reportDraft');
    alert("æš‚å­˜å·²æ¸…é™¤");
  }
}

document.addEventListener('input', e => {
  if (e.target.closest('#section-report')) saveDraft();
});

// å¯¼å…¥/å¯¼å‡º JSON ä¿æŒåŸæ ·
document.getElementById('exportJsonBtn').addEventListener('click', () => {
  const report = localStorage.getItem('reportDraft');
  const history = localStorage.getItem('profitHistory');
  if (!report && !history) return alert('âš ï¸ æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼');
  const data = { reportDraft: JSON.parse(report || '{}'), profitHistory: JSON.parse(history || '[]') };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `æŠ¥è¡¨å¤‡ä»½-${new Date().toLocaleDateString()}.json`;
  a.click();
  URL.revokeObjectURL(url);
});
const fileInput = document.getElementById('importJsonFile');
document.getElementById('importJsonBtn').addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const json = JSON.parse(evt.target.result);
      if (!json || typeof json !== 'object') throw new Error();
      if (json.reportDraft) localStorage.setItem('reportDraft', JSON.stringify(json.reportDraft));
      if (json.profitHistory) localStorage.setItem('profitHistory', JSON.stringify(json.profitHistory));
      alert('âœ… å¯¼å…¥æˆåŠŸï¼Œé¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ã€‚');
      location.reload();
    } catch { alert('âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ã€‚'); }
  };
  reader.readAsText(file);
  fileInput.value = '';
});


  // åˆå§‹åŒ–
  window.addEventListener('load', function () {
    if (!loadDraft()) {
      addRow('é˜¿å›½ç¾¤', 0, 1.1, 'è¿”ç‚¹ç¾¤');
    }
    renderHistory();
  });

// ============ å·¥èµ„æ”¯å‡ºæ±‡æ€»åŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆï¼‰ ============
function sumSalaryReports() {
  const files = document.getElementById('salaryFiles').files;
  if (!files.length) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä»½æˆ–å¤šä»½æŠ¥è¡¨ TXT æ–‡ä»¶ï¼");

  const salaryTotals = {}; // åŠ¨æ€è®°å½•å·¥èµ„ç±»å‹ä¸é‡‘é¢
  const lines = [];
  let processed = 0;

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const text = e.target.result;

      // âœ… åŒ¹é…æ‰€æœ‰ â€œå·¥èµ„æ”¯å‡ºXï¼šé‡‘é¢â€
      const matches = [...text.matchAll(/å·¥èµ„æ”¯å‡º([^\ï¼š:]+)ï¼š\s*([\d.]+)/g)];

      matches.forEach(m => {
        const label = m[1].trim();  // å·¥èµ„æ ‡ç­¾ï¼Œå¦‚ A/B/F/Y...
        const amount = parseFloat(m[2]) || 0;

        // æ±‡æ€»
        if (!salaryTotals[label]) salaryTotals[label] = 0;
        salaryTotals[label] += amount;

        lines.push(`${file.name} - å·¥èµ„æ”¯å‡º${label}ï¼š${amount} U`);
      });

      processed++;
      if (processed === files.length) {
        // ç”Ÿæˆè¾“å‡º
        let summary = `ğŸ“Š æ±‡æ€»æ˜ç»†ï¼š\n\n${lines.join('\n')}\n\n`;

        let grandTotal = 0;
        for (const [label, total] of Object.entries(salaryTotals)) {
          summary += `ğŸ“Œ å·¥èµ„æ”¯å‡º${label}åˆè®¡ï¼š${total.toFixed(2)} U\n`;
          grandTotal += total;
        }

        summary += `\nâœ… å·¥èµ„æ”¯å‡ºæ€»è®¡ï¼š${grandTotal.toFixed(2)} U\n`;
        document.getElementById('salarySummary').textContent = summary;
      }
    };
    reader.readAsText(file);
  });
}

</script>
</body>
</html>
