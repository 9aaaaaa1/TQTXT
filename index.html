<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“±æŸ¥   ä¼šå‘è´¢---æ‰‹æœºå·åŒ¹é…æå–å·¥å…·</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body{font-family:sans-serif;max-width:1000px;margin:20px auto;padding:0 15px;}
    h1{margin-bottom:20px;}
    .tabs{display:flex;gap:10px;margin-bottom:20px;}
    .tab{flex:1;text-align:center;padding:10px;background:#f1f1f1;border-radius:6px;cursor:pointer;font-weight:bold;}
    .tab.active{background:#1a73e8;color:#fff;}
    .card{border:1px solid #ddd;border-radius:8px;padding:16px;}
    .btn{padding:8px 14px;background:#1a73e8;color:#fff;border:none;border-radius:6px;cursor:pointer;margin:6px 6px 6px 0;display:inline-block;text-decoration:none;}
    .btn.disabled{opacity:.5;pointer-events:none;}
    textarea{width:100%;height:150px;margin-top:10px;}
    .summary{margin-top:10px;font-weight:bold;}
    .dropzone{border:2px dashed #ccc;padding:20px;text-align:center;margin:10px 0;cursor:pointer;background:#fafafa;}
    .dropzone.dragover{background:#e3f2fd;border-color:#2196f3;}
    .hidden{display:none;}
  </style>
</head>
<body>
  <h1>ğŸ“± ä¼šå‘è´¢---æ‰‹æœºå·åŒ¹é…æå–å·¥å…·</h1>

  <!-- é¡¶éƒ¨ Tab -->
  <div class="tabs">
    <div class="tab active" onclick="showTab('part1', this)">æ–‡ä»¶1 vs æ–‡ä»¶2 åŒ¹é…</div>
    <div class="tab" onclick="showTab('part2', this)">CSV vs TXT åŒ¹é…</div>
    <div class="tab" onclick="showTab('part3', this)">å·æ®µç­›é€‰</div>
  </div>

  <!-- Part 1 -->
  <div id="part1" class="card">
    <h2>æ–‡ä»¶1 vs æ–‡ä»¶2 åŒ¹é…ï¼ˆæ”¯æŒç²¾ç¡® / æ¨¡ç³Šï¼‰</h2>
    <div class="dropzone" id="drop1">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼  æ–‡ä»¶1ï¼ˆæŸ¥é‡å·ç ï¼‰</div>
    <input type="file" id="file1" style="display:none" accept=".txt">
    <div class="dropzone" id="drop2">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼  æ–‡ä»¶2ï¼ˆåŸå·åŒ…ï¼‰</div>
    <input type="file" id="file2" style="display:none" accept=".txt">
    <div>
      åŒ¹é…æ–¹å¼ï¼š
      <select id="matchType">
        <option value="exact">ç²¾ç¡®åŒ¹é…</option>
        <option value="fuzzy">æ¨¡ç³ŠåŒ¹é…ï¼ˆå‰10ä½ï¼‰</option>
      </select>
      <button class="btn" onclick="matchData()">å¼€å§‹åŒ¹é…</button>
      <button class="btn" onclick="downloadResult()">ä¸‹è½½åŒ¹é…ç»“æœ</button>
      <button class="btn" onclick="downloadUnmatched()">ä¸‹è½½æœªåŒ¹é…æ•°æ®</button>
    </div>
    <div id="summary" class="summary">ç­‰å¾…åŒ¹é…...</div>
    <h3>âœ… åŒ¹é…ç»“æœ</h3>
    <textarea id="matchedBox">--</textarea>
    <h3>âŒ æœªåŒ¹é…ç»“æœ</h3>
    <textarea id="unmatchedBox">--</textarea>
  </div>

  <!-- Part 2 -->
  <div id="part2" class="card hidden">
    <h2>CSV vs TXT åŒ¹é…</h2>
    <h3>ä¸Šä¼  CSV æ–‡ä»¶ (å«æ‰‹æœºå·åˆ—)</h3>
    <input id="csvFiles" type="file" accept=".csv,.txt" multiple />
    <h3>ä¸Šä¼  TXT æ–‡ä»¶ (æ•°æ®æº)</h3>
    <input id="txtFiles" type="file" accept=".txt,.csv" multiple />
    <div>
      <button id="parseBtn" class="btn">å¼€å§‹åŒ¹é…</button>
      <a id="downloadBtn" class="btn disabled" href="#">ä¸‹è½½ç»“æœ TXT</a>
    </div>
    <p id="resultInfo"></p>
    <textarea id="previewBox" placeholder="ç»“æœé¢„è§ˆ (å‰50è¡Œ)"></textarea>
  </div>

  <!-- Part 3 -->
  <div id="part3" class="card hidden">
    <h2>å·æ®µç­›é€‰åŠŸèƒ½</h2>
    <p>ä¸Šä¼ ä¸€ä¸ª TXT æ–‡ä»¶ï¼Œå¹¶è¾“å…¥è¦ç­›é€‰çš„å·æ®µï¼Œä¾‹å¦‚ <b>255</b>ï¼š</p>
    <input id="segmentFile" type="file" accept=".txt,.csv" />
    <input id="segmentInput" type="text" placeholder="è¾“å…¥å·æ®µ (å¦‚ 255)" />
    <div>
      <button id="segmentBtn" class="btn">ç­›é€‰å·æ®µ</button>
      <a id="downloadSegBtn" class="btn disabled" href="#">ä¸‹è½½å·æ®µç»“æœ</a>
      <a id="downloadRemainBtn" class="btn disabled" href="#">ä¸‹è½½å‰©ä½™å·ç </a>
    </div>
    <p id="segmentInfo"></p>
  </div>

  <script>
    // Tab åˆ‡æ¢
    function showTab(id, el){
      document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
    }

    // é€šç”¨å·¥å…·
    function cleanPhone(v){ if(v==null) return ""; return String(v).replace(/\D+/g, ""); }
    function detectDelimiter(sampleText){
      const comma=(sampleText.match(/,/g)||[]).length;
      const tab=(sampleText.match(/\t/g)||[]).length;
      return (tab>comma) ? "\t" : ",";
    }
    function readAsText(file){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(fr.result);
        fr.onerror=reject;
        fr.readAsText(file,'utf-8');
      });
    }

    // ============ Part1 ============
    let matchedLines=[], unmatchedLines=[];
    function setupDropzone(dropId, inputId){
      const dropzone=document.getElementById(dropId);
      const fileInput=document.getElementById(inputId);
      dropzone.addEventListener("click",()=>fileInput.click());
      dropzone.addEventListener("dragover",e=>{e.preventDefault();dropzone.classList.add("dragover");});
      dropzone.addEventListener("dragleave",()=>dropzone.classList.remove("dragover"));
      dropzone.addEventListener("drop",e=>{
        e.preventDefault();dropzone.classList.remove("dragover");
        const file=e.dataTransfer.files[0];fileInput.files=e.dataTransfer.files;
        dropzone.textContent=`å·²ä¸Šä¼ ï¼š${file.name}`;
      });
      fileInput.addEventListener("change",()=>{
        if(fileInput.files.length>0) dropzone.textContent=`å·²ä¸Šä¼ ï¼š${fileInput.files[0].name}`;
      });
    }
    setupDropzone("drop1","file1");
    setupDropzone("drop2","file2");

    async function matchData(){
      document.getElementById('summary').textContent='æ­£åœ¨åŒ¹é…...';
      document.getElementById('matchedBox').value='';
      document.getElementById('unmatchedBox').value='';
      matchedLines=[];unmatchedLines=[];
      try{
        const file1Text=await readAsText(document.getElementById('file1').files[0]);
        const file2Text=await readAsText(document.getElementById('file2').files[0]);
        const matchType=document.getElementById('matchType').value;
        const phones1=file1Text.split(/\r?\n/).map(l=>l.trim().split(',')[0]).filter(x=>x);
        const lines2=file2Text.split(/\r?\n/).filter(l=>l.trim());
        let set1=new Set(matchType==='fuzzy'?phones1.map(p=>p.slice(0,10)):phones1);
        matchedLines=lines2.filter(line=>{
          const key=matchType==='fuzzy'?line.split(',')[0].slice(0,10):line.split(',')[0];
          return set1.has(key);
        });
        unmatchedLines=lines2.filter(line=>{
          const key=matchType==='fuzzy'?line.split(',')[0].slice(0,10):line.split(',')[0];
          return !set1.has(key);
        });
        document.getElementById('summary').textContent=`åŒ¹é…åˆ° ${matchedLines.length} æ¡ï¼ŒæœªåŒ¹é… ${unmatchedLines.length} æ¡`;
        document.getElementById('matchedBox').value=matchedLines.join("\n")||"--";
        document.getElementById('unmatchedBox').value=unmatchedLines.join("\n")||"--";
      }catch(e){console.error(e);document.getElementById('summary').textContent='åŒ¹é…å¤±è´¥';}
    }
    function downloadResult(){
      if(matchedLines.length===0){alert('æ— åŒ¹é…ç»“æœ');return;}
      const blob=new Blob([matchedLines.join('\n')],{type:'text/plain'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download='åŒ¹é…ç»“æœ.txt';a.click();URL.revokeObjectURL(a.href);
    }
    function downloadUnmatched(){
      if(unmatchedLines.length===0){alert('æ— æœªåŒ¹é…æ•°æ®');return;}
      const blob=new Blob([unmatchedLines.join('\n')],{type:'text/plain'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download='æœªåŒ¹é…æ•°æ®.txt';a.click();URL.revokeObjectURL(a.href);
    }

    // ============ Part2 ============
    let csvPhonesSet=new Set(), txtRows=[], matchedRows=[];
    async function handleCSV(){
      csvPhonesSet.clear(); if(!csvFiles.files?.length) return;
      for(const file of csvFiles.files){
        const text=await readAsText(file);
        const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
        const headers=parsed.meta.fields;
        const phoneCol=headers.find(h=>h.includes("æ‰‹æœºå·")||h.toLowerCase().includes("phone"))||headers[0];
        parsed.data.forEach(row=>{const ph=cleanPhone(row[phoneCol]);if(ph)csvPhonesSet.add(ph);});
      }
      resultInfo.textContent=`å·²åŠ è½½ ${csvFiles.files.length} ä¸ª CSVï¼Œå…±æå– ${csvPhonesSet.size} ä¸ªæ‰‹æœºå·`;
    }
    async function handleTXT(){
      txtRows=[]; if(!txtFiles.files?.length) return;
      for(const file of txtFiles.files){
        const text=await readAsText(file);
        const delim=detectDelimiter(text.slice(0,2000));
        const parsed=Papa.parse(text,{header:false,delimiter:delim,skipEmptyLines:true});
        parsed.data.forEach(r=>txtRows.push(r));
      }
      resultInfo.textContent=`å·²åŠ è½½ ${txtFiles.files.length} ä¸ª TXTï¼Œæ€»è¡Œæ•° ${txtRows.length}`;
    }
    parseBtn.addEventListener('click',()=>{
      matchedRows=[];txtRows.forEach(r=>{const phone=cleanPhone(r[0]);if(csvPhonesSet.has(phone))matchedRows.push(r);});
      const lines=matchedRows.map(r=>r.join(","));
      const blob=new Blob([lines.join("\n")],{type:'text/plain;charset=utf-8'});
      const url=URL.createObjectURL(blob);downloadBtn.href=url;
      downloadBtn.download=`matched_phone_data_${Date.now()}.txt`;downloadBtn.classList.remove('disabled');
      resultInfo.textContent=`åŒ¹é…å®Œæˆï¼š${matchedRows.length} è¡Œ`;previewBox.value=lines.slice(0,50).join("\n");
    });
    csvFiles.addEventListener('change',handleCSV);
    txtFiles.addEventListener('change',handleTXT);

    // ============ Part3 ============
    segmentBtn.addEventListener('click',async()=>{
      if(!segmentFile.files?.length){alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªTXTæ–‡ä»¶');return;}
      const text=await readAsText(segmentFile.files[0]);
      const delim=detectDelimiter(text.slice(0,2000));
      const parsed=Papa.parse(text,{header:false,delimiter:delim,skipEmptyLines:true});
      const rows=parsed.data;const seg=segmentInput.value.trim();
      if(!seg){alert('è¯·è¾“å…¥å·æ®µ');return;}
      let matched=[],remain=[];
      rows.forEach(r=>{const ph=cleanPhone(r[0]);if(ph.startsWith(seg))matched.push(r);else remain.push(r);});
      const matchedLines=matched.map(r=>r.join(",")), remainLines=remain.map(r=>r.join(","));
      const blob1=new Blob([matchedLines.join("\n")],{type:'text/plain;charset=utf-8'});
      const blob2=new Blob([remainLines.join("\n")],{type:'text/plain;charset=utf-8'});
      downloadSegBtn.href=URL.createObjectURL(blob1);downloadSegBtn.download=`segment_${seg}_${matched.length}_${Date.now()}.txt`;downloadSegBtn.textContent=`ä¸‹è½½å·æ®µç»“æœ (${matched.length} è¡Œ)`;downloadSegBtn.classList.remove('disabled');
      downloadRemainBtn.href=URL.createObjectURL(blob2);downloadRemainBtn.download=`remain_except_${seg}_${remain.length}_${Date.now()}.txt`;downloadRemainBtn.textContent=`ä¸‹è½½å‰©ä½™å·ç  (${remain.length} è¡Œ)`;downloadRemainBtn.classList.remove('disabled');
      segmentInfo.textContent=`ç­›é€‰å®Œæˆï¼šå·æ®µ ${seg} â†’ ${matched.length} è¡Œï¼›å‰©ä½™ ${remain.length} è¡Œ`;
    });
  </script>
</body>
</html>
