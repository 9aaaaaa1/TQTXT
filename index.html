<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ä¼šå‘è´¢é›†å›¢</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: #f0f2f5;
      padding: 30px;
    }

    h2, h3 {
      margin-top: 20px;
      color: #333;
    }

    .menu {
      margin-bottom: 20px;
    }

    .menu button {
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      background-color: #1890ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .menu button:hover {
      background-color: #40a9ff;
    }

    .section {
      display: none;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .section.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    input, textarea {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }

    pre {
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h2>ğŸ›  ä¼šå‘è´¢é›†å›¢å¤šåŠŸèƒ½å·¥å…·</h2>

<div class="menu">
  <button onclick="showSection('txt')">ğŸ“‚ TXT æ–‡æœ¬æå–</button>
  <button onclick="showSection('report')">ğŸ“Š æŠ¥è¡¨å·¥å…·</button>
</div>

<!-- TXTæå–å·¥å…· -->
<div id="section-txt" class="section">
  <h3>ğŸ“‚ æå– TXT æ–‡ä»¶çš„å‰ N è¡Œ</h3>

  <input type="file" id="fileInput" accept=".txt"><br>
  <label>è¾“å…¥è¦æå–çš„è¡Œæ•°ï¼š</label>
  <input type="number" id="lineCount" min="1" value="5"><br>
  <button onclick="processFile()">æå–å¹¶ç”Ÿæˆæ–‡ä»¶</button>

  <div id="result" style="margin-top:20px;"></div>
</div>

<!-- æŠ¥è¡¨å·¥å…· -->
<div id="section-report" class="section">
  <h3>ğŸ“Š ç¾¤å‡ºå·æŠ¥è¡¨å·¥å…·</h3>

  <table id="groupTable">
    <thead>
      <tr>
        <th>ç¾¤å</th>
        <th>å‡ºå·æ•°</th>
        <th>å•ä»·</th>
        <th>æ”¶å…¥</th>
        <th>å¤‡æ³¨</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addRow()">â• æ·»åŠ ç¾¤</button>

  <h4>å‚æ•°è®¾ç½®</h4>
  <label>çœŸæœº/åè®®æˆæœ¬ï¼š</label>
  <input type="number" id="baseCost" value="2795">
  <label>å·¥èµ„æ”¯å‡ºï¼š</label>
  <input type="number" id="salaryCost" value="90">
  <label>è¿”ç‚¹ç¾¤åï¼š</label>
  <input type="text" id="rebateGroup" value="é˜¿å›½ç¾¤">
  <label>è¿”ç‚¹æ¯”ä¾‹ï¼š</label>
  <input type="number" step="0.01" id="rebateRate" value="0.15">

  <button onclick="calculate()">ğŸ“Š è®¡ç®—æŠ¥è¡¨</button>
  <button onclick="exportTXT()">ğŸ“¥ å¯¼å‡ºæŠ¥è¡¨</button>
  <button onclick="exportHistory()">ğŸ“¤ å¯¼å‡ºå†å²</button>
  <button onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤å†å²</button>
  <button onclick="clearDraft()">ğŸ—‘ æ¸…é™¤æš‚å­˜</button>

  <!-- âœ… æ–°å¢çš„ JSON å¯¼å…¥å¯¼å‡ºåŠŸèƒ½æŒ‰é’® -->
  <button id="exportJsonBtn">ğŸ’¾ å¯¼å‡ºæŠ¥è¡¨ JSON</button>
  <button id="importJsonBtn">ğŸ“‚ å¯¼å…¥æŠ¥è¡¨ JSON</button>
  <input type="file" id="importJsonFile" accept=".json" style="display:none;">

  <h4>ğŸ“„ æŠ¥è¡¨é¢„è§ˆï¼š</h4>
  <pre id="output">ç‚¹å‡»â€œè®¡ç®—æŠ¥è¡¨â€åæ˜¾ç¤º</pre>

  <h4>ğŸ“ˆ å†å²åˆ©æ¶¦è®°å½•</h4>
  <ul id="historyList"></ul>
</div>

<script>
  function showSection(id) {
    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('section-' + id).classList.add('active');
  }

  showSection('txt'); // é»˜è®¤æ˜¾ç¤º txt æå–å·¥å…·

  // ================== TXT æå– ==================
  function processFile() {
    const fileInput = document.getElementById('fileInput');
    const lineCount = parseInt(document.getElementById('lineCount').value);
    if (!fileInput.files[0]) return alert("è¯·å…ˆé€‰æ‹© TXT æ–‡ä»¶");

    const reader = new FileReader();
    reader.onload = function (e) {
      const lines = e.target.result.split(/\r?\n/);
      const extractPart = lines.slice(0, lineCount).join("\n");
      const remainingPart = lines.slice(lineCount).join("\n");

      createDownloadLink(extractPart, 'æå–éƒ¨åˆ†.txt');
      createDownloadLink(remainingPart, 'å‰©ä½™éƒ¨åˆ†.txt');
    };
    reader.readAsText(fileInput.files[0]);
  }

  function createDownloadLink(text, filename) {
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.textContent = `ğŸ“¥ ä¸‹è½½ï¼š${filename}`;
    link.style.display = 'block';
    document.getElementById('result').appendChild(link);
  }

  // ================== æŠ¥è¡¨åŠŸèƒ½ ==================
  let latestReport = '';
  function addRow(group = '', count = '', price = '', remark = '') {
    const tbody = document.querySelector('#groupTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${group}" class="groupName"></td>
      <td><input type="number" value="${count}" class="count" oninput="updateIncome(this)"></td>
      <td><input type="number" value="${price}" class="price" oninput="updateIncome(this)"></td>
      <td><input class="income" readonly></td>
      <td><input value="${remark}" class="remark"></td>
      <td><button onclick="this.closest('tr').remove(); saveDraft();">åˆ é™¤</button></td>
    `;
    tbody.appendChild(tr);
    updateIncome(tr.querySelector('.count'));
  }

  function updateIncome(elem) {
    const row = elem.closest('tr');
    const count = parseFloat(row.querySelector('.count').value) || 0;
    const price = parseFloat(row.querySelector('.price').value) || 0;
    row.querySelector('.income').value = (count * price).toFixed(2);
    saveDraft();
  }

  function calculate() {
    const rows = document.querySelectorAll('#groupTable tbody tr');
    const baseCost = parseFloat(document.getElementById('baseCost').value) || 0;
    const salaryCost = parseFloat(document.getElementById('salaryCost').value) || 0;
    const rebateGroup = document.getElementById('rebateGroup').value.trim();
    const rebateRate = parseFloat(document.getElementById('rebateRate').value) || 0;

    let totalCount = 0, totalIncome = 0, rebateAmount = 0, lines = [];
    rows.forEach(row => {
      const group = row.querySelector('.groupName').value.trim();
      const count = parseFloat(row.querySelector('.count').value) || 0;
      const price = parseFloat(row.querySelector('.price').value) || 0;
      const income = count * price;
      const remark = row.querySelector('.remark').value.trim();
      totalCount += count;
      totalIncome += income;
      let line = `${group.padEnd(8)} å‡ºå·æ•°: ${count}    å•ä»·: ${price}    æ”¶å…¥: ${income.toFixed(2)}`;
      if (remark) line += `    å¤‡æ³¨: ${remark}`;
      lines.push(line);
      if (group === rebateGroup) rebateAmount = count * rebateRate;
    });

    const totalCost = baseCost + salaryCost + rebateAmount;
    const profit = totalIncome - totalCost;
    const agentFee = profit * 0.1;
    const finalProfit = profit - agentFee;

    let output = `ğŸ“… ç¾¤å‘å·æ˜ç»†\n\n`;
    output += lines.map(line => line + '\n').join('\n');
    output += `\nğŸ“Œ åˆè®¡å‡ºå·æ•°ï¼š${totalCount} ä¸ª\n\n`;
    output += `ğŸ“Œ åˆè®¡æ”¶å…¥ï¼š${totalIncome.toFixed(2)} U\n\n`;
    output += `ä¸€ã€çœŸæœºåè®®æˆæœ¬ï¼š${baseCost.toFixed(2)} U\n\n`;
    output += `äºŒã€å·¥èµ„æ”¯å‡ºï¼š${salaryCost.toFixed(2)} U\n\n`;
    output += `ä¸‰ã€è¿”ç‚¹ï¼ˆ${rebateGroup}ï¼‰ï¼š${rebateAmount.toFixed(2)} U\n\n`;
    output += `å››ã€æ€»æ”¯å‡ºï¼š${totalCost.toFixed(2)} U\n\n`;
    output += `äº”ã€åˆ©æ¶¦ï¼š${totalIncome.toFixed(2)} - ${totalCost.toFixed(2)} = ${profit.toFixed(2)} U\n\n`;
    output += `å…­ã€ä»£ç†ææˆï¼ˆ10%ï¼‰ï¼š${agentFee.toFixed(2)} U\n\n`;
    output += `âœ… æœ€ç»ˆåˆ©æ¶¦ï¼š${finalProfit.toFixed(2)} U\n`;

    latestReport = output;
    document.getElementById('output').textContent = output;

    const today = new Date().toISOString().slice(0, 10);
    let history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
    const currentProfit = parseFloat(finalProfit.toFixed(2));
    const index = history.findIndex(item => item.date === today);
    if (index >= 0) {
      if (currentProfit > parseFloat(history[index].profit)) {
        history[index].profit = currentProfit.toFixed(2);
      }
    } else {
      history.push({ date: today, profit: currentProfit.toFixed(2) });
    }
    localStorage.setItem('profitHistory', JSON.stringify(history));
    renderHistory();
  }

  function exportTXT() {
    if (!latestReport) return alert("è¯·å…ˆç‚¹å‡»â€œè®¡ç®—æŠ¥è¡¨â€");
    const today = new Date().toISOString().slice(0, 10);
    const blob = new Blob([latestReport], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `æŠ¥è¡¨-${today}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function renderHistory() {
    const list = document.getElementById('historyList');
    const history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
    list.innerHTML = '';
    let total = 0;
    history.forEach(item => {
      total += parseFloat(item.profit);
      const li = document.createElement('li');
      li.textContent = `${item.date}ï¼š${item.profit} U`;
      list.appendChild(li);
    });
    if (history.length > 0) {
      const li = document.createElement('li');
      li.innerHTML = `<strong>ğŸ“Š æ€»åˆ©æ¶¦åˆè®¡ï¼š${total.toFixed(2)} U</strong>`;
      list.appendChild(li);
    }
  }

  function clearHistory() {
    if (confirm("ç¡®å®šæ¸…é™¤æ‰€æœ‰å†å²è®°å½•ï¼Ÿ")) {
      localStorage.removeItem('profitHistory');
      renderHistory();
    }
  }

  function exportHistory() {
    const history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
    if (!history.length) return alert("æš‚æ— å†å²è®°å½•");
    let total = 0;
    let text = `ğŸ“ˆ å†å²åˆ©æ¶¦è®°å½•\n\n`;
    history.forEach(item => {
      total += parseFloat(item.profit);
      text += `${item.date}ï¼š${item.profit} U\n\n`;
    });
    text += `ğŸ“Š æ€»åˆ©æ¶¦åˆè®¡ï¼š${total.toFixed(2)} U\n`;

    const today = new Date().toISOString().slice(0, 10);
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `å†å²åˆ©æ¶¦-${today}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ======= æš‚å­˜åŠŸèƒ½ =======
  function saveDraft() {
    const rows = document.querySelectorAll('#groupTable tbody tr');
    const draftData = {
      groups: [],
      baseCost: document.getElementById('baseCost').value,
      salaryCost: document.getElementById('salaryCost').value,
      rebateGroup: document.getElementById('rebateGroup').value,
      rebateRate: document.getElementById('rebateRate').value
    };
    rows.forEach(row => {
      draftData.groups.push({
        groupName: row.querySelector('.groupName').value,
        count: row.querySelector('.count').value,
        price: row.querySelector('.price').value,
        remark: row.querySelector('.remark').value
      });
    });
    localStorage.setItem('reportDraft', JSON.stringify(draftData));
  }

  function loadDraft() {
    const draft = localStorage.getItem('reportDraft');
    if (!draft) return false;
    const data = JSON.parse(draft);
    document.querySelector('#groupTable tbody').innerHTML = '';
    data.groups.forEach(g => {
      addRow(g.groupName, g.count, g.price, g.remark);
    });
    document.getElementById('baseCost').value = data.baseCost;
    document.getElementById('salaryCost').value = data.salaryCost;
    document.getElementById('rebateGroup').value = data.rebateGroup;
    document.getElementById('rebateRate').value = data.rebateRate;
    return true;
  }

  function clearDraft() {
    if (confirm("ç¡®å®šæ¸…é™¤æš‚å­˜æ•°æ®ï¼Ÿ")) {
      localStorage.removeItem('reportDraft');
      alert("æš‚å­˜å·²æ¸…é™¤");
    }
  }

  document.addEventListener('input', function (e) {
    if (e.target.closest('#section-report')) {
      saveDraft();
    }
  });

  // âœ… æ–°å¢å¯¼å…¥/å¯¼å‡º JSON åŠŸèƒ½
  document.getElementById('exportJsonBtn').addEventListener('click', () => {
    const report = localStorage.getItem('reportDraft');
    const history = localStorage.getItem('profitHistory');
    if (!report && !history) return alert('âš ï¸ æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼');
    const data = { reportDraft: JSON.parse(report || '{}'), profitHistory: JSON.parse(history || '[]') };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `æŠ¥è¡¨å¤‡ä»½-${new Date().toLocaleDateString()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  const fileInput = document.getElementById('importJsonFile');
  document.getElementById('importJsonBtn').addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        const json = JSON.parse(evt.target.result);
        if (!json || typeof json !== 'object') throw new Error();
        if (json.reportDraft) localStorage.setItem('reportDraft', JSON.stringify(json.reportDraft));
        if (json.profitHistory) localStorage.setItem('profitHistory', JSON.stringify(json.profitHistory));
        alert('âœ… å¯¼å…¥æˆåŠŸï¼Œé¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥åŠ è½½æ–°æ•°æ®ã€‚');
        location.reload();
      } catch {
        alert('âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®è®¤ JSON å†…å®¹æ­£ç¡®ã€‚');
      }
    };
    reader.readAsText(file);
    fileInput.value = '';
  });

  // åˆå§‹åŒ–
  window.addEventListener('load', function () {
    if (!loadDraft()) {
      addRow('é˜¿å›½ç¾¤', 0, 1.1, 'è¿”ç‚¹ç¾¤');
    }
    renderHistory();
  });
</script>
</body>
</html>
